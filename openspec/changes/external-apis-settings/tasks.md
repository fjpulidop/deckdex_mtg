## 1. Backend: user_settings table and API

- [ ] 1.1 Create migration `migrations/012_user_settings.sql` (or next available number): `user_settings` table with `user_id` (integer UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE), `settings` (JSONB NOT NULL DEFAULT '{}'), `created_at` (TIMESTAMPTZ DEFAULT now()), `updated_at` (TIMESTAMPTZ DEFAULT now()). Add index on `user_id`.
- [ ] 1.2 Create `deckdex/storage/user_settings_repository.py`: `UserSettingsRepository` class initialized with a database URL (same pattern as `CollectionRepository` and `DeckRepository`). Methods: `get_user_settings(user_id) -> dict` (returns full JSONB or `{}` if no row), `upsert_user_settings(user_id, settings: dict)` (INSERT ON CONFLICT UPDATE, set `updated_at`), `get_external_apis_settings(user_id) -> dict` (extracts `external_apis` from JSONB, returns `{"scryfall_enabled": false}` as default), `update_external_apis_settings(user_id, settings: dict)` (merges into `external_apis` key in JSONB, upserts row).
- [ ] 1.3 Add `get_user_settings_repo()` to `backend/api/dependencies.py`: return `UserSettingsRepository(url)` when `DATABASE_URL` is set, else `None`. Follow same pattern as `get_deck_repo()`.
- [ ] 1.4 Add endpoints to `backend/api/routes/settings_routes.py`: `GET /api/settings/external-apis` (requires `user_id: int = Depends(get_current_user_id)`, calls `UserSettingsRepository.get_external_apis_settings(user_id)`, returns `ExternalApisSettingsResponse(scryfall_enabled=bool)`). `PUT /api/settings/external-apis` (requires `user_id`, accepts `ExternalApisSettingsUpdate(scryfall_enabled: bool)`, calls `UserSettingsRepository.update_external_apis_settings(user_id, ...)`, returns `ExternalApisSettingsResponse`). Both return 503 if `UserSettingsRepository` is not available (no Postgres). Add Pydantic models `ExternalApisSettingsResponse` and `ExternalApisSettingsUpdate` in the same file.
- [ ] 1.5 Run migration against dev database and verify `user_settings` table is created correctly.

## 2. Backend: catalog-first lookup refactor

- [ ] 2.1 Refactor `suggest_card_names(q, user_id)` in `backend/api/services/scryfall_service.py`: (1) get `CatalogRepository` from dependencies, (2) call `catalog_repo.autocomplete(q)`, (3) if results found, return them, (4) if empty, call `UserSettingsRepository.get_external_apis_settings(user_id)`, (5) if `scryfall_enabled`, fall back to existing `fetcher.autocomplete(q)`, (6) if disabled, return empty list. Update function signature to accept `user_id: int`.
- [ ] 2.2 Refactor `resolve_card_by_name(name, user_id)` in `backend/api/services/scryfall_service.py`: (1) get `CatalogRepository` from dependencies, (2) call `catalog_repo.search_by_name(name, limit=1)` for exact/fuzzy match, (3) if found, map catalog row to the card dict format (same keys as current Scryfall mapping: name, type, rarity, set_name, price, description, mana_cost, cmc, power, toughness, colors, color_identity), (4) if not found, check user settings, (5) if `scryfall_enabled`, fall back to existing `fetcher.search_card(name)` + mapping, (6) if disabled, raise `CardNotFoundError` with descriptive message. Update function signature to accept `user_id: int`.
- [ ] 2.3 Refactor `get_card_image(card_id, user_id)` in `backend/api/services/card_image_service.py`: after resolving the card row and `scryfall_id`, (1) check `ImageStore.exists(scryfall_id)` or `ImageStore.get(scryfall_id)` first (this includes catalog-synced images), (2) if image exists, return it, (3) if not, check user settings via `UserSettingsRepository.get_external_apis_settings(user_id)`, (4) if `scryfall_enabled`, proceed with Scryfall image download (existing logic), (5) if disabled, raise `FileNotFoundError` with descriptive message. Update function signature to accept `user_id: int`.
- [ ] 2.4 Refactor `_run_import()` in `backend/api/services/importer_service.py`: modify the enrichment loop to (1) search `CatalogRepository` for each `ParsedCard.name` first, (2) if found in catalog, use catalog data for enrichment (map catalog fields to enriched card dict), (3) if not found, check user settings, (4) if `scryfall_enabled`, fall back to `fetcher.search_card(name)`, (5) if disabled, add to `not_found` list. The `ImporterService.__init__` should accept `user_id` (it already does). Use `UserSettingsRepository` to check `scryfall_enabled` once at the start of the import (not per-card).
- [ ] 2.5 Update all route call sites to pass `user_id`:
  - `backend/api/routes/cards.py`: `GET /api/cards/suggest` calls `suggest_card_names(q, user_id)` (add `user_id: int = Depends(get_current_user_id)` to the route if not already present).
  - `backend/api/routes/cards.py`: `GET /api/cards/resolve` calls `resolve_card_by_name(name, user_id)`.
  - `backend/api/routes/cards.py`: `GET /api/cards/{id}/image` calls `get_card_image(card_id, user_id)`.
  - `backend/api/routes/import_routes.py`: `ImporterService` constructor already receives `user_id`; ensure it is passed through to `_run_import()` for the settings check.

## 3. Frontend: Settings UI update

- [ ] 3.1 Add API client methods to `frontend/src/api/client.ts`: `getExternalApisSettings()` (calls `GET /api/settings/external-apis`, returns `{ scryfall_enabled: boolean }`), `updateExternalApisSettings(settings: { scryfall_enabled: boolean })` (calls `PUT /api/settings/external-apis` with JSON body, returns `{ scryfall_enabled: boolean }`). Add `ExternalApisSettings` interface: `{ scryfall_enabled: boolean }`.
- [ ] 3.2 Add "APIs externas" section to `frontend/src/components/SettingsModal.tsx`: new `<section>` between the "Scryfall API credentials" section and the "Importar coleccion" section. Section title: `<h3>APIs externas</h3>`. Contains a labeled toggle/switch for "Scryfall" with description: "Permite al sistema consultar la API de Scryfall cuando una carta no se encuentra en el catalogo local." (or English equivalent). Load initial state from `api.getExternalApisSettings()` in a `useEffect`. On toggle change, call `api.updateExternalApisSettings({ scryfall_enabled: newValue })`. Show loading state while saving. Show error message on failure and revert toggle.
- [ ] 3.3 Style the toggle following existing SettingsModal patterns: use Tailwind classes consistent with the rest of the modal. Toggle component can be a styled checkbox, a `<button>` with `role="switch"`, or a dedicated switch component. Match dark mode styles (`dark:bg-gray-*`, `dark:text-*`).

## 4. Tests

- [ ] 4.1 Unit tests for `UserSettingsRepository`: test `get_external_apis_settings` returns default when no row, returns saved value after upsert, handles missing `external_apis` key gracefully. Test `update_external_apis_settings` creates row on first call, updates on second call, preserves other JSONB keys when updating `external_apis`. Use test database or mock.
- [ ] 4.2 Unit tests for settings API endpoints: test `GET /api/settings/external-apis` returns 200 with default values for new user, returns saved values after PUT. Test `PUT /api/settings/external-apis` with valid body returns 200, with invalid body returns 422, without auth returns 401. Use `TestClient` with mocked `UserSettingsRepository`.
- [ ] 4.3 Unit tests for catalog-first lookup in `scryfall_service.py`: test `suggest_card_names` returns catalog results when available (no Scryfall call), falls back to Scryfall when catalog empty and enabled, returns empty when catalog empty and disabled. Test `resolve_card_by_name` returns catalog data when found, falls back to Scryfall when not found and enabled, raises `CardNotFoundError` when not found and disabled. Mock `CatalogRepository` and `UserSettingsRepository`.
- [ ] 4.4 Unit tests for catalog-first lookup in `card_image_service.py`: test `get_card_image` returns ImageStore image when exists (no Scryfall call), falls back to Scryfall download when not in store and enabled, raises `FileNotFoundError` when not in store and disabled. Mock `ImageStore` and `UserSettingsRepository`.
- [ ] 4.5 Unit tests for catalog-first import enrichment: test `_run_import` uses catalog data when available, falls back to Scryfall when not in catalog and enabled, adds to `not_found` when not in catalog and disabled. Mock `CatalogRepository`, `UserSettingsRepository`, and `CardFetcher`.
- [ ] 4.6 Frontend: verify the "APIs externas" section renders in SettingsModal, toggle loads from API, toggle change calls PUT endpoint, error handling reverts toggle on failure. Manual verification or component test with mocked API.
